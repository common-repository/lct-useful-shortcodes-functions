var lctinternallinkShortcodeUI;!function(u){var i=window.lctinternallinkShortcodeUI={models:{},collections:{},views:{},utils:{},strings:{}};i.models.ShortcodeAttribute=Backbone.Model.extend({defaults:{attr:"",label:"",type:"",section:"",description:"",default:"",value:""}}),i.models.ShortcodeAttributes=Backbone.Collection.extend({model:i.models.ShortcodeAttribute,clone:function(){return new this.constructor(_.map(this.models,function(t){return t.clone()}))}}),i.models.Shortcode=Backbone.Model.extend({defaults:{label:"",shortcode_tag:"",action_tag:"",attrs:i.models.ShortcodeAttributes},set:function(t,e){return void 0===t.attrs||t.attrs instanceof i.models.ShortcodeAttributes||(_.each(t.attrs,function(t){null!=t.default&&(t.value=t.default)}),t.attrs=new i.models.ShortcodeAttributes(t.attrs)),Backbone.Model.prototype.set.call(this,t,e)},toJSON:function(t){return void 0!==(t=Backbone.Model.prototype.toJSON.call(this,t)).attrs&&t.attrs instanceof i.models.ShortcodeAttributes&&(t.attrs=t.attrs.toJSON()),t},clone:function(){var t=Backbone.Model.prototype.clone.call(this);return t.set("attrs",t.get("attrs").clone()),t},formatShortcode:function(){var t,i,r=[];return this.get("attrs").each(function(t){var e=t.get("value"),o=t.get("type"),n=t.get("default");(!e||e.length<1)&&"checkbox"!=o||"checkbox"==o&&"true"!=n&&!e||("content"===t.get("attr")?i=t.get("value"):r.push(t.get("attr")+'="'+e+'"'))}),t="[{{ shortcode }} {{ attributes }}]",i&&0<i.length&&(t+="{{ content }}[/{{ shortcode }}]"),t=(t=(t=t.replace(/{{ shortcode }}/g,this.get("shortcode_tag"))).replace(/{{ attributes }}/g,r.join(" "))).replace(/{{ content }}/g,i)},validate:function(t){var e=[];return t.attrs.findWhere({attr:"id"}).get("value")||e.push({id:i.strings.pleaseEnterAnID}),e.length?e:null}}),i.collections.Shortcodes=Backbone.Collection.extend({model:i.models.Shortcode}),i.views.editShortcodeForm=wp.Backbone.View.extend({el:"#lct_internal_link-shortcode-ui-container",template:wp.template("lct_internal_link-shortcode-default-edit-form"),hasAdvancedValue:!1,events:{"click #lct_internal_link-update-shortcode":"insertShortcode","click #lct_internal_link-insert-shortcode":"insertShortcode","click #lct_internal_link-cancel-shortcode":"cancelShortcode"},initialize:function(){_.bindAll(this,"beforeRender","render","afterRender");var e=this;this.render=_.wrap(this.render,function(t){return e.beforeRender(),t(),e.afterRender(),e}),this.model.get("attrs").each(function(t){switch(t.get("section")){case"required":e.views.add(".lct-edit-shortcode-form-required-attrs",new i.views.editAttributeField({model:t,parent:e}));break;case"standard":e.views.add(".lct-edit-shortcode-form-standard-attrs",new i.views.editAttributeField({model:t,parent:e}));break;default:e.views.add(".lct-edit-shortcode-form-advanced-attrs",new i.views.editAttributeField({model:t,parent:e})),e.hasAdvancedVal||(e.hasAdvancedVal=""!==t.get("value"))}}),this.listenTo(this.model,"change",this.render)},beforeRender:function(){},afterRender:function(){lct_initialize_tooltips(),u("#lct_internal_link-insert-shortcode").toggle("insert"==this.options.viewMode),u("#lct_internal_link-update-shortcode").toggle("insert"!=this.options.viewMode),u("#lct-edit-shortcode-form-advanced-attrs").toggle(this.hasAdvancedVal)},insertShortcode:function(t){this.model.isValid({validate:!0})?(send_to_editor(this.model.formatShortcode()),tb_remove(),this.dispose()):_.each(this.model.validationError,function(t){_.each(t,function(t,e){alert(t)})})},cancelShortcode:function(t){tb_remove(),this.dispose()},dispose:function(){this.remove(),u("#lct_internal_link-shortcode-ui-wrap").append('<div id="lct_internal_link-shortcode-ui-container"></div>')}}),i.views.editAttributeField=Backbone.View.extend({tagName:"div",initialize:function(t){this.parent=t.parent},events:{'keyup  input[type="text"]':"updateValue","keyup  textarea":"updateValue","change select":"updateValue","change #lct-shortcode-attr-action":"updateAction","change input[type=checkbox]":"updateCheckbox","change input[type=radio]":"updateValue","change input[type=email]":"updateValue","change input[type=number]":"updateValue","change input[type=date]":"updateValue","change input[type=url]":"updateValue"},render:function(){return this.template=wp.media.template("lct-shortcode-ui-field-"+this.model.get("type")),this.$el.html(this.template(this.model.toJSON()))},updateValue:function(t){t=u(t.target);this.model.set("value",t.val())},updateCheckbox:function(t){t=u(t.target).prop("checked");this.model.set("value",t)},updateAction:function(t){var t=u(t.target).val(),e=(this.model.set("value",t),this.parent.model),t=i.shortcodes.findWhere({shortcode_tag:"lct_internal_link",action_tag:t}),n=e.get("attrs"),e=(t.get("attrs").each(function(t){var e=t.get("attr"),o=n.findWhere({attr:e});void 0!==o&&e==o.get("attr")&&(e=o.get("value"),t.set("value",String(e)))}),u(this.parent.el).empty(),this.parent.options.viewMode);this.parent.dispose(),this.parent.model.set(t),(lctinternallinkShortcodeUI=new i.views.editShortcodeForm({model:t,viewMode:e})).render()}}),i.utils.shortcodeViewConstructor={initialize:function(t){this.shortcodeModel=this.getShortcodeModel(this.shortcode)},getShortcodeModel:function(e){var t=void 0!==e.attrs.named.action?e.attrs.named.action:"",t=i.shortcodes.findWhere({action_tag:t});if(t)return t=t.clone(),t.get("attrs").each(function(t){t.get("attr")in e.attrs.named&&t.set("value",e.attrs.named[t.get("attr")]),"content"===t.get("attr")&&"content"in e&&t.set("value",e.content)}),t},getContent:function(){return this.content||this.fetch(),this.content},fetch:function(){var t,e=this;this.fetching||(this.fetching=!0,t=this.shortcodeModel.get("attrs").findWhere({attr:"id"}).get("value"),t={action:"lct_do_shortcode",post_id:u("#post_ID").val(),form_id:t,shortcode:this.shortcodeModel.formatShortcode()},u.post(ajaxurl,t).done(function(t){e.content=t}).fail(function(){e.content='<span class="lct_shortcode_ui_error">'+lct_internal_linkShortcodeUIData.strings.errorLoadingPreview+"</span>"}).always(function(){delete e.fetching,e.render()}))},setLoader:function(){this.setContent('<div class="loading-placeholder"><div class="dashicons dashicons-feedback"></div><div class="wpview-loading"><ins></ins></div></div>')},View:{overlay:!0,shortcodeHTML:!1,setContent:function(i,r){this.getNodes(function(t,e,o){var o="wrap"===r||"replace"===r?e:o,n=i;_.isString(n)&&(n=t.dom.createFragment(n)),"replace"===r?t.dom.replace(n,o):"remove"===r?(e.parentNode.insertBefore(n,e.nextSibling),u(e).remove()):(o.innerHTML="",o.appendChild(n))})},initialize:function(e){var t=void 0!==e.shortcode.attrs.named.action?e.shortcode.attrs.named.action:"",t=i.shortcodes.findWhere({action_tag:t});t?((t=t.clone()).get("attrs").each(function(t){t.get("attr")in e.shortcode.attrs.named&&t.set("value",e.shortcode.attrs.named[t.get("attr")]),"content"===t.get("attr")&&"content"in e.shortcode&&t.set("value",e.shortcode.content)}),this.shortcode=t):(this.shortcodeHTML=decodeURIComponent(e.encodedText),this.shortcode=!1)},loadingPlaceholder:function(){return'<div class="loading-placeholder"><div class="dashicons dashicons-feedback"></div><div class="wpview-loading"><ins></ins></div></div>'},getEditors:function(e){var o=[];return _.each(tinymce.editors,function(t){t.plugins.wpview&&(e&&e(t),o.push(t))},this),o},getNodes:function(n){var i=[],t=this;return this.getEditors(function(o){u(o.getBody()).find('[data-wpview-text="'+t.encodedText+'"]').each(function(t,e){n&&n(o,e,u(e).find(".wpview-content").get(0)),i.push(e)})}),i},setIframes:function(l){var h=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver;-1===l.indexOf("<script")?(this.shortcodeHTML=l,this.render()):this.getNodes(function(t,e,o){var n,i,r,a,d=t.dom,s="",c=t.getBody().className||"";o.innerHTML="";wp.mce.views.sandboxStyles?s=wp.mce.views.sandboxStyles:(tinymce.each(d.$('link[rel="stylesheet"]',t.getDoc().head),function(t){t.href&&-1===t.href.indexOf("skins/lightgray/content.min.css")&&-1===t.href.indexOf("skins/wordpress/wp-content.css")&&(s+=d.getOuterHTML(t)+"\n")}),wp.mce.views.sandboxStyles=s),setTimeout(function(){if(n=d.add(o,"iframe",{src:tinymce.Env.ie?'javascript:""':"",frameBorder:"0",id:"lct_internal_link-shortcode-preview-"+(new Date).getTime(),allowTransparency:"true",scrolling:"no",class:"wpview-sandbox",style:{width:"100%",display:"block"}}),(i=n.contentWindow.document).open(),i.write('<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />'+s+'<style>html {background: transparent;padding: 0;margin: 0;}body#wpview-iframe-sandbox {background: transparent;padding: 1px 0 !important;margin: -1px 0 0 !important;}body#wpview-iframe-sandbox:before,body#wpview-iframe-sandbox:after {display: none;content: "";}</style></head><body id="wpview-iframe-sandbox" class="'+c+'">'+l+"</body></html>"),i.close(),a=function(){n.contentWindow&&u(n).height(u(i.body).height())},h)new h(_.debounce(function(){a()},100)).observe(i.body,{attributes:!0,childList:!0,subtree:!0});else for(r=1;r<6;r++)setTimeout(a,700*r);a(),t.on("wp-body-class-change",function(){i.body.className=t.getBody().className})},50)})},getHtml:function(){var t;{if(this.shortcode)return!1===this.shortcodeHTML&&(t=this.shortcode.get("attrs").findWhere({attr:"id"}).get("value"),t={action:"lct_do_shortcode",post_id:u("#post_ID").val(),form_id:t,shortcode:this.shortcode.formatShortcode()},u.post(ajaxurl,t,u.proxy(this.setIframes,this))),this.shortcodeHTML;this.setContent(this.shortcodeHTML,"remove")}}},edit:function(t){var o,e;"object"==typeof t&&(t=decodeURIComponent(jQuery(t).attr("data-wpview-text"))),(t=wp.shortcode.next("lct_internal_link",t))&&(e=t.shortcode.attrs.named.action||"",(e=i.shortcodes.findWhere({shortcode_tag:t.shortcode.tag,action_tag:e}))&&(o=e.clone(),_.each(t.shortcode.attrs.named,function(t,e){(attr=o.get("attrs").findWhere({attr:e}))&&attr.set("value",t)}),e=o.get("attrs").findWhere({attr:"id"}).get("value"),u("#add_lct_internal_link_id").val(e),(lctinternallinkShortcodeUI=new i.views.editShortcodeForm({model:o,viewMode:"update"})).render(),u("#lct_internal_link-insert-shortcode").hide(),u("#lct_internal_link-update-shortcode").show(),tb_show("Edit Page Title","#TB_inline?inlineId=select_lct_internal_link&width=753&height=686","")))}},u(document).ready(function(){i.strings=lct_internal_linkShortcodeUIData.strings,i.shortcodes=new i.collections.Shortcodes(lct_internal_linkShortcodeUIData.shortcodes),lct_internal_linkShortcodeUIData.previewDisabled||void 0===wp.mce||wp.mce.views.register("lct_internal_link",u.extend(!0,{},i.utils.shortcodeViewConstructor)),u(document).on("click",".lct_internal_link_media_link",function(){i.shortcodes=new i.collections.Shortcodes(lct_internal_linkShortcodeUIData.shortcodes);var t=i.shortcodes.findWhere({shortcode_tag:"link",action_tag:""});(lctinternallinkShortcodeUI=new i.views.editShortcodeForm({model:t,viewMode:"insert"})).render(),tb_show("Insert an Internal Link","#TB_inline?inlineId=select_lct_internal_link&width=753&height=686","")})})}((window.lctinternallinkzxzpShortCodeUI=window.lctinternallinkzxzpShortCodeUI||{},jQuery));